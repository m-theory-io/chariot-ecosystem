# Azure production docker-compose configuration
# Uses pre-built binaries for fast, reliable deployment

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    platform: linux/amd64
    container_name: chariot-mysql-prod
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-chariot_root_2024}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-chariot}
      MYSQL_USER: ${MYSQL_USER:-chariot}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-chariot123}
    volumes:
      - mysql_data_prod:/var/lib/mysql
      - ./databases/mysql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 20s
      retries: 15
      start_period: 60s

  # Couchbase Database
  couchbase:
    image: couchbase:community
    platform: linux/amd64
    container_name: chariot-couchbase-prod
    ports:
      - "8091-8096:8091-8096"
      - "11210:11210"
    environment:
      - CLUSTER_NAME=chariot-cluster
    volumes:
      - couchbase_data_prod:/opt/couchbase/var
      - ./databases/couchbase:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/ui/index.html"]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 60s

  # Go-Chariot API Service
  go-chariot:
    image: "mtheorycontainerregistry.azurecr.io/go-chariot:${GO_CHARIOT_TAG:-v0.001}"
    container_name: chariot-api-prod
    environment:
      - CHARIOT_PORT=8087
      - CHARIOT_SSL=false
      - CHARIOT_HEADLESS=false
      # Azure Key Vault configuration (firewall rule added)
      - CHARIOT_VAULT_NAME=${AZURE_VAULT_NAME:-chariot-vault}
      - CHARIOT_VAULT_KEY_PREFIX=azure
      # Data/tree paths and bootstrap script
      - CHARIOT_DATA_PATH=/app/data
      - CHARIOT_TREE_PATH=/app/data/trees
      - CHARIOT_BOOTSTRAP=bootstrap.ch
    ports:
      - "8087:8087"
    depends_on:
      mysql:
        condition: service_healthy
      couchbase:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./data/go-chariot:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/health"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 60s

  # Charioteer Web Editor
  charioteer:
    image: "mtheorycontainerregistry.azurecr.io/charioteer:${CHARIOTEER_TAG:-amd64}"
    container_name: chariot-editor-prod
    command: ["/app/charioteer", "-ssl=false", "-backend=http://go-chariot:8087"]
    environment:
      - CHARIOT_BACKEND_URL=http://go-chariot:8087
      - NODE_ENV=production
      - SSL_ENABLED=false
      - USE_SSL=false
      - DISABLE_SSL=true
      - HTTP_ONLY=true
      - COOKIE_SECRET=${COOKIE_SECRET:-dev_cookie_secret_change_in_production}
    ports:
      - "8080:8080"
    depends_on:
      go-chariot:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./data/charioteer:/app/files
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/charioteer/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Visual DSL Frontend
  visual-dsl:
    image: "mtheorycontainerregistry.azurecr.io/visual-dsl:${VISUAL_DSL_TAG:-v0.001}"
    container_name: visual-dsl
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
      - ssl=false
      - SSL_ENABLED=false
      - USE_SSL=false
      - HTTPS=false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: "mtheorycontainerregistry.azurecr.io/nginx:${NGINX_TAG:-amd64}"
    container_name: chariot-nginx-prod
    ports:
      - "80:80"
      - "443:443"
      - "3307:3307"
    volumes:
      - certbot_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      - go-chariot
      - charioteer
      - visual-dsl
      - oauth2-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -skf https://localhost:443/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # OAuth2 Proxy - Azure AD Authentication Gateway (internal only)
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: chariot-oauth2-proxy
    restart: unless-stopped
    expose:
      - "4180"
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_AZURE_TENANT=${AZURE_TENANT_ID}
      - OAUTH2_PROXY_CLIENT_ID=${AZURE_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${AZURE_CLIENT_SECRET}
      - OAUTH2_PROXY_OIDC_ISSUER_URL=https://login.microsoftonline.com/${AZURE_TENANT_ID}/v2.0
      - OAUTH2_PROXY_SCOPE=openid profile email
      - OAUTH2_PROXY_OIDC_EMAIL_CLAIM=preferred_username
      - OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL=true
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REDIRECT_URL=https://chariot.m-theory.io/oauth2/callback
      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_COOKIE_SAMESITE=lax
      - OAUTH2_PROXY_COOKIE_DOMAINS=chariot.m-theory.io
      - OAUTH2_PROXY_COOKIE_NAME=_oauth2_proxy_chariot
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_ALLOWED_REDIRECT_DOMAINS=chariot.m-theory.io
      - OAUTH2_PROXY_WHITELIST_DOMAIN=chariot.m-theory.io
      - OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE=/etc/oauth2-proxy/authenticated-emails.txt
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=false
      - OAUTH2_PROXY_PASS_USER_HEADERS=false
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_REQUEST_LOGGING=true
      - OAUTH2_PROXY_STANDARD_LOGGING=true
      - OAUTH2_PROXY_AUTH_LOGGING=true
      - OAUTH2_PROXY_SHOW_DEBUG_ON_ERROR=true
      - OAUTH2_PROXY_SESSION_STORE_TYPE=redis
      - OAUTH2_PROXY_REDIS_CONNECTION_URL=redis://redis:6379
      - OAUTH2_PROXY_SKIP_AUTH_ROUTES=^/visual-dsl/visual_dsl_favicon\.svg$
    volumes:
      # Bind-mount a real file from the VM (create it on the host). Defaults to /home/mtheory/.oauth2-proxy/authenticated-emails.txt
      - "${OAUTH2_EMAILS_FILE:-/home/mtheory/.oauth2-proxy/authenticated-emails.txt}:/etc/oauth2-proxy/authenticated-emails.txt:ro"
  # No container healthcheck (distroless image lacks curl/wget).

  # Redis for oauth2-proxy session storage
  redis:
    image: redis:7-alpine
    container_name: chariot-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data_prod:/data

volumes:
  mysql_data_prod:
    driver: local
  couchbase_data_prod:
    driver: local
  certbot_certs:
    external: true
    name: mtheory_certbot_certs
  certbot_www:
    external: true
    name: mtheory_certbot_www
  redis_data_prod:
    driver: local

networks:
  default:
    name: chariot-network-prod
