# Azure production docker-compose configuration
# Uses pre-built binaries for fast, reliable deployment

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    platform: linux/amd64
    container_name: chariot-mysql-prod
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-chariot_root_2024}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-chariot}
      MYSQL_USER: ${MYSQL_USER:-chariot}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-chariot123}
    volumes:
      - mysql_data_prod:/var/lib/mysql
      - ./databases/mysql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 20s
      retries: 15
      start_period: 60s

  # Couchbase Database
  couchbase:
    image: couchbase:community
    platform: linux/amd64
    container_name: chariot-couchbase-prod
    ports:
      - "8091-8096:8091-8096"
      - "11210:11210"
    environment:
      - CLUSTER_NAME=chariot-cluster
    volumes:
      - couchbase_data_prod:/opt/couchbase/var
      - ./databases/couchbase:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/ui/index.html"]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 60s

  # Go-Chariot API Service
  go-chariot:
    image: "mtheorycontainerregistry.azurecr.io/go-chariot:${GO_CHARIOT_TAG:-amd64}"
    container_name: chariot-api-prod
    environment:
      - CHARIOT_PORT=8087
      - CHARIOT_SSL=false
      - CHARIOT_HEADLESS=false
      # Azure Key Vault configuration (firewall rule added)
      - CHARIOT_VAULT_NAME=${AZURE_VAULT_NAME:-chariot-vault}
      - CHARIOT_VAULT_KEY_PREFIX=azure
      # Data/tree paths and bootstrap script
      - CHARIOT_DATA_PATH=/app/data
      - CHARIOT_TREE_PATH=/app/data/trees
      - CHARIOT_BOOTSTRAP=bootstrap.ch
    ports:
      - "8087:8087"
    # Do not mount /app/data in production so embedded bootstrap assets are visible
    depends_on:
      mysql:
        condition: service_healthy
      couchbase:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/health"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 60s

  # Charioteer Web Editor
  charioteer:
    image: mtheorycontainerregistry.azurecr.io/charioteer:amd64
    container_name: chariot-editor-prod
    command: ["/app/charioteer", "-ssl=false", "-backend=http://go-chariot:8087"]
    environment:
      - CHARIOT_BACKEND_URL=http://go-chariot:8087
      - NODE_ENV=production
      - SSL_ENABLED=false
      - USE_SSL=false
      - DISABLE_SSL=true
      - HTTP_ONLY=true
      - COOKIE_SECRET=${COOKIE_SECRET:-dev_cookie_secret_change_in_production}
    ports:
      - "8080:8080"
    depends_on:
      go-chariot:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/charioteer/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Visual DSL Frontend
  visual-dsl:
    image: "mtheorycontainerregistry.azurecr.io/visual-dsl:${VISUAL_DSL_TAG:-amd64}"
    container_name: visual-dsl
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
      - ssl=false  # Disable SSL - nginx handles SSL termination
      - SSL_ENABLED=false
      - USE_SSL=false
      - HTTPS=false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: mtheorycontainerregistry.azurecr.io/nginx:amd64
    container_name: chariot-nginx-prod
    ports:
      - "80:80"
      - "443:443"
      - "3307:3307"  # MySQL proxy port
    volumes:
      # Mount certbot Docker volumes (created by Let's Encrypt setup)
      - certbot_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      - go-chariot
      - charioteer
      - visual-dsl
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -skf https://localhost:443/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  mysql_data_prod:
    driver: local
  couchbase_data_prod:
    driver: local
  # External volumes created by certbot compose/setup
  certbot_certs:
    external: true
    name: mtheory_certbot_certs
  certbot_www:
    external: true
    name: mtheory_certbot_www

networks:
  default:
    name: chariot-network-prod
